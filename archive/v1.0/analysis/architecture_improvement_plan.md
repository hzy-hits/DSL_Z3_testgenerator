# 测试生成系统架构改进方案

## 当前架构的根本问题

### 1. 命名空间不一致
- **DSL层**：使用`entity_attribute`格式（如`customer_age`）
- **Z3层**：正确使用了前缀格式
- **输出层**：丢失了实体前缀，只输出`attribute`

### 2. 抽象泄漏
- 业务逻辑硬编码在通用验证器中
- Z3特定逻辑泄漏到上层
- 缺少清晰的接口定义

### 3. 职责混乱
- 验证器既做验证又做修复
- 生成器既生成又去重
- 引擎既协调又包含业务逻辑

## 改进方案

### 第一阶段：修复关键问题（P0）

#### 1. 统一命名空间
```python
# 在Attribute类中添加完整名称
@dataclass
class Attribute:
    name: str
    entity_name: str  # 新增
    
    @property
    def full_name(self) -> str:
        return f"{self.entity_name.lower()}_{self.name}"
```

#### 2. 修复测试输出格式
确保所有测试数据使用完整的`entity_attribute`名称

#### 3. 正确应用规则
- 修复`->`符号的支持 ✓
- 确保规则在测试生成时被验证

### 第二阶段：架构重构（P1）

#### 1. 分层架构
```
┌─────────────────────────────────────┐
│         DSL Parser Layer            │
│     (解析和验证DSL定义)              │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│      Test Strategy Layer            │
│   (决定生成哪些类型的测试)           │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│    Constraint Solver Layer          │
│      (Z3求解具体测试值)              │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│      Validation Layer               │
│    (验证测试的有效性)                │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│       Output Layer                  │
│    (格式化和输出测试)                │
└─────────────────────────────────────┘
```

#### 2. 接口定义
```python
# 清晰的接口定义
class TestGenerator(ABC):
    @abstractmethod
    def generate(self, model: DSLModel) -> List[TestCase]:
        pass

class ConstraintSolver(ABC):
    @abstractmethod
    def solve(self, constraints: List[Constraint]) -> Optional[Solution]:
        pass

class TestValidator(ABC):
    @abstractmethod
    def validate(self, test: TestCase, model: DSLModel) -> bool:
        pass
```

#### 3. 插件化架构
- 允许注册特定领域的验证器
- 支持自定义测试策略
- 可配置的输出格式

### 第三阶段：优化测试生成（P2）

#### 1. 智能测试选择
- 基于覆盖目标生成最少必要测试
- 消除冗余测试
- 优先级排序

#### 2. 测试目的明确化
每个测试都应该有明确的目的：
- 测试什么约束/规则
- 预期的行为
- 为什么这个测试是必要的

#### 3. 可解释性
- 记录为什么生成某个测试
- 显示测试覆盖了哪些需求
- 提供测试优化建议

## 实施计划

### 立即修复（1天）
1. ✓ 修复`->`符号支持
2. ⚡ 修复输出格式中的实体前缀问题
3. ⚡ 确保规则验证正确工作

### 短期改进（1周）
1. 实现统一的命名空间管理
2. 分离验证和修复逻辑
3. 改进测试去重策略

### 长期重构（1月）
1. 实现分层架构
2. 建立插件系统
3. 优化测试生成算法

## 成功标准

1. **正确性**：生成的测试100%符合DSL定义
2. **精简性**：每个测试都有明确目的，无冗余
3. **可扩展**：易于添加新的领域和规则
4. **可维护**：代码结构清晰，职责单一

## 预期效果

- 测试数量减少50-70%
- 测试质量提升到9/10
- 支持更复杂的DSL定义
- 更容易添加新功能